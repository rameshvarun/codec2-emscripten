<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Codec2.js</title>

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65"
      crossorigin="anonymous"
    />
  </head>
  <body>
    <main class="container">
      <div class="text-center">
        <h1>Codec2.js Demo Page</h1>
      </div>
      <hr />
      <div class="row">
        <div class="col-sm">
          <h1>Codec 2 Encoder</h1>
          <div id="enc-root"></div>
        </div>
        <div class="col-sm">
          <h1>Codec 2 Decoder</h1>
          <div id="dec-root"></div>
        </div>
      </div>
    </main>

    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4"
      crossorigin="anonymous"
    ></script>
    <script
      crossorigin
      src="https://unpkg.com/react@18/umd/react.development.js"
    ></script>
    <script
      crossorigin
      src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"
    ></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/htm/3.1.1/htm.min.js"
      integrity="sha512-KexadEzXSG37kmTjpJaBzflzUoGFDyXbhVCcvYmLQtR/P0b5WYZZi8kPXc2cYcmI+c1gqxnknlF+fuwYQbZVvg=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>

    <script src="./c2enc.js"></script>
    <script src="./c2dec.js"></script>
    <script src="./sox.js"></script>
    <script>
      const html = htm.bind(React.createElement);

      function hexToArrayBuffer(hex) {
        return new Uint8Array(
          hex.match(/[\da-f]{2}/gi).map(function (h) {
            return parseInt(h, 16);
          })
        ).buffer;
      }

      function arrayBufferToHex(buffer) {
        return [...new Uint8Array(buffer)]
          .map(x => x.toString(16).padStart(2, '0'))
          .join('');
      }

      function runDecode(mode, data) {
        return new Promise((resolve, reject) => {
          const module = {
            arguments: [mode, "input.bit", "output.raw"],
            preRun: () => {
              module.FS.writeFile("input.bit", new Uint8Array(data));
            },
            postRun: () => {
              let buffer = module.FS.readFile("output.raw", {
                encoding: "binary",
              });
              resolve(buffer);
            },
          };
          createC2Dec(module);
        });
      }

      function rawToWav(buffer) {
        return new Promise((resolve, reject) => {
          const module = {
            arguments: ["-r", "8000", "-L", "-e", "signed-integer", "-b", "16", "-c", "1", "input.raw", "output.wav"],
            preRun: () => {
              module.FS.writeFile("input.raw", new Uint8Array(buffer));
            },
            postRun: () => {
              let output = module.FS.readFile("output.wav", {
                encoding: "binary",
              });
              resolve(output);
            },
          };
          SOXModule(module);
        });
      }

      class Decoder extends React.Component {
        render() {
          return html`<div>
            <div><textarea id="decode-hex-input">
              74e98150e1854230e1c081f07214012072094160e1c541f04629ed4051fb
              f110c160a930c149e950043f7d90c58f7db04e5ebda07e23397044c658b0
              2b8a60c02dce60d04072d8c018bf28f09092f100b1a4801037ea008084bb
              dc007890a010a302bd80161b7540705e841090568400597f8110a6ad14a0
              e1b04000e1c741104629e9304650a510c3da80c03a4cc0d02bd4f5402db3
              ad306dae8540fca8410001b940d0cdf7d800d9082000b9e57160255abd50
              2f197d30843ef9101ff7e000dd85a4005f1f0000c8de88609a82c000dc86
              00007b2318a08c555ce08c0dd4908c0dd0406badd010785d8c005f291000
              bb49dc00bb5e18004875c000abf90120e1ff812093f60210723f4190e1c3
              8000e1b0c170e1f102d0fad74120721a8170eea9c240abb78180e1ff8310
              </textarea></div>
            <select id="decode-mode-select">
              <option default value="700C">700C</option>
            </select>

            <button onClick=${() => this.decode()}>Decode</button>

            <div><audio id="decode-playback" controls></audio></div>
          </div>`;
        }

        async decode() {
          const hex = document.getElementById("decode-hex-input").value;
          const buffer = hexToArrayBuffer(hex);
          const mode = document.getElementById("decode-mode-select").value;

          let decodedRaw = await runDecode(mode, buffer);
          let wavBuffer = await rawToWav(decodedRaw);

          document.getElementById("decode-playback").src = URL.createObjectURL(new Blob([wavBuffer], { type: "audio/wav"}));
        }
      }

      ReactDOM.createRoot(document.getElementById("dec-root")).render(
        React.createElement(Decoder)
      );
    </script>
  </body>
</html>
